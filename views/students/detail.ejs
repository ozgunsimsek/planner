<%- contentFor('body') %>

<head>
    <title>Öğrenci Detay - <%= student.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        /* Select2 özelleştirmeleri */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection--single {
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="/students" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left me-2"></i>
            Geri Dön
        </a>
        <h2 class="mb-0">
            <i class="bi bi-person me-2"></i>
            Öğrenci Detayı
        </h2>
    </div>
    <div>
        <a href="/print-template/<%= student.id %>" target="_blank" class="btn btn-primary">
            Plan Görüntüle
        </a>
    </div>
</div>

<!-- Öğrenci Bilgileri -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <div class="profile-icon">
                <i class="bi bi-person"></i>
            </div>
            <div>
                <h3 class="card-title mb-1"><%= student.name %></h3>
                <p class="text-muted mb-0"><%= student.email %> | <%= student.grade %>. Sınıf</p>
            </div>
        </div>
    </div>
</div>

<!-- Ders Ekleme Formu -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>
            Ders Ekle
        </h4>
    </div>
    <div class="card-body">
        <form id="addSubjectForm" class="row g-3">
            <div class="col-md-5">
                <label class="form-label">Ders</label>
                <select class="form-select subject-select" id="subjectSelect" required>
                    <option value="">Ders Seçin</option>
                    <option value="Matematik">Matematik</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Kimya">Kimya</option>
                    <option value="Biyoloji">Biyoloji</option>
                    <option value="Türkçe">Türkçe</option>
                    <option value="Geometri">Geometri</option>
                    <option value="Tarih">Tarih</option>
                    <option value="Coğrafya">Coğrafya</option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Konu</label>
                <select class="form-select topic-select" id="topicSelect" required>
                    <option value="">Konu Seçin</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus-lg me-2"></i>
                    Ekle
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Haftalık Plan -->
<div class="card">
    <div class="card-header">
        <h4 class="mb-0">
            <i class="bi bi-calendar-week me-2"></i>
            Haftalık Plan
        </h4>
    </div>
    <div class="card-body">
        <div id="subjectsContainer" class="mb-4">
            <% if (student.weeklySchedule && student.weeklySchedule[0] && student.weeklySchedule[0].subjects) { %>
                <% student.weeklySchedule[0].subjects.forEach((subject, subjectIndex) => { %>
                    <div class="subject-row d-flex align-items-center gap-3 mb-3">
                        <div class="flex-grow-1">
                            <input type="text" 
                                   name="subjects[<%= subjectIndex %>][subject]" 
                                   value="<%= subject.subject %>"
                                   class="form-control"
                                   placeholder="Ders adı"
                                   onchange="autoSave()">
                        </div>
                        <div class="flex-grow-1">
                            <input type="text" 
                                   name="subjects[<%= subjectIndex %>][notes]" 
                                   value="<%= subject.notes %>"
                                   class="form-control"
                                   placeholder="Notlar"
                                   onchange="autoSave()">
                        </div>
                        <button type="button" 
                                onclick="removeSubject(this)"
                                class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// Ders-Konu eşleştirmeleri
const subjectTopics = {
    'Matematik': [
        'Temel Kavramlar',
        'Sayılar',
        'Rasyonel Sayılar',
        'Mutlak Değer',
        'Üslü Sayılar',
        'Köklü Sayılar',
        'Çarpanlara Ayırma',
        'Oran-Orantı',
        'Denklemler',
        'Eşitsizlikler',
        'Fonksiyonlar',
        'Polinomlar',
        'İkinci Dereceden Denklemler',
        'Karmaşık Sayılar',
        'Logaritma',
        'Diziler',
        'Seriler',
        'Limit',
        'Türev',
        'İntegral'
    ],
    'Fizik': [
        'Fizik Bilimine Giriş',
        'Madde ve Özellikleri',
        'Hareket ve Kuvvet',
        'Enerji',
        'Isı ve Sıcaklık',
        'Elektrik ve Manyetizma',
        'Basınç',
        'Dalgalar',
        'Optik',
        'Atom Fiziği'
    ],
    'Kimya': [
        'Kimya Bilimi',
        'Atom ve Periyodik Sistem',
        'Kimyasal Türler Arası Etkileşimler',
        'Maddenin Halleri',
        'Karışımlar',
        'Asitler, Bazlar ve Tuzlar',
        'Kimya Her Yerde',
        'Kimyanın Temel Kanunları',
        'Mol Kavramı',
        'Kimyasal Tepkimeler'
    ],
    'Biyoloji': [
        'Biyoloji Bilimi',
        'Canlıların Yapısı',
        'Hücre',
        'Canlıların Çeşitliliği',
        'Üreme',
        'Kalıtım',
        'Ekosistem',
        'Güncel Çevre Sorunları',
        'Canlılar ve Enerji',
        'İnsan Fizyolojisi'
    ],
    'Türkçe': [
        'Sözcükte Anlam',
        'Cümlede Anlam',
        'Paragrafta Anlam',
        'Anlatım Teknikleri',
        'Düşünceyi Geliştirme Yolları',
        'Sözcük Türleri',
        'Fiilimsiler',
        'Cümlenin Ögeleri',
        'Cümle Türleri',
        'Anlatım Bozuklukları',
        'Ses Bilgisi',
        'Yazım Kuralları',
        'Noktalama İşaretleri'
    ],
    'Geometri': [
        'Temel Kavramlar',
        'Doğruda Açılar',
        'Üçgende Açılar',
        'Üçgende Açı-Kenar Bağıntıları',
        'Üçgende Alan',
        'Üçgende Benzerlik',
        'Dik Üçgen',
        'İkizkenar Üçgen',
        'Eşkenar Üçgen',
        'Dörtgenler',
        'Çokgenler',
        'Çemberde Açılar',
        'Çemberde Uzunluk',
        'Dairede Alan',
        'Katı Cisimler'
    ],
    'Tarih': [
        'Tarih Bilimi',
        'İlk Uygarlıklar',
        'İlk Türk Devletleri',
        'İslam Tarihi ve Uygarlığı',
        'Türk-İslam Devletleri',
        'Osmanlı Devleti Kuruluş Dönemi',
        'Osmanlı Devleti Yükselme Dönemi',
        'Osmanlı Devleti Duraklama Dönemi',
        'Osmanlı Devleti Gerileme Dönemi',
        'Osmanlı Devleti Dağılma Dönemi',
        'Kurtuluş Savaşı',
        'Atatürk Dönemi',
        'Çağdaş Türk ve Dünya Tarihi'
    ],
    'Coğrafya': [
        'Doğa ve İnsan',
        'Dünya\'nın Şekli ve Hareketleri',
        'Coğrafi Konum',
        'Harita Bilgisi',
        'İklim Bilgisi',
        'Yerşekilleri',
        'Nüfus ve Yerleşme',
        'Türkiye\'nin Fiziki Özellikleri',
        'Türkiye\'nin İklimi',
        'Türkiye\'nin Nüfusu',
        'Türkiye\'nin Ekonomik Coğrafyası',
        'Bölgeler ve Ülkeler',
        'Çevre ve Toplum'
    ]
};

// Ders seçildiğinde konuları güncelle
document.getElementById('subjectSelect').addEventListener('change', function() {
    const topicSelect = document.getElementById('topicSelect');
    const selectedSubject = this.value;
    
    // Konu seçimini sıfırla
    topicSelect.innerHTML = '<option value="">Konu Seçin</option>';
    
    if (selectedSubject && subjectTopics[selectedSubject]) {
        subjectTopics[selectedSubject].forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
        });
    }
});

// Yeni ders ekleme
document.getElementById('addSubjectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subject = document.getElementById('subjectSelect').value;
    const topic = document.getElementById('topicSelect').value;
    
    if (!subject || !topic) return;
    
    const container = document.getElementById('subjectsContainer');
    const subjectCount = container.children.length;
    
    const subjectRow = document.createElement('div');
    subjectRow.className = 'subject-row d-flex align-items-center gap-3 mb-3';
    subjectRow.innerHTML = `
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[${subjectCount}][subject]" 
                   value="${subject}"
                   class="form-control"
                   placeholder="Ders adı"
                   onchange="autoSave()">
        </div>
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[${subjectCount}][notes]" 
                   value="${topic}"
                   class="form-control"
                   placeholder="Notlar"
                   onchange="autoSave()">
        </div>
        <button type="button" 
                onclick="removeSubject(this)"
                class="btn btn-outline-danger">
            <i class="bi bi-trash"></i>
        </button>
    `;
    
    container.appendChild(subjectRow);
    
    // Formu sıfırla
    this.reset();
    
    // Select2'leri sıfırla
    $('#subjectSelect').val('').trigger('change');
    $('#topicSelect').val('').trigger('change');
    
    // Konu seçimini sıfırla
    document.getElementById('topicSelect').innerHTML = '<option value="">Konu Seçin</option>';
    $('#topicSelect').select2('destroy').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    });

    // Otomatik kaydet
    await autoSave();
});

// Ders silme
function removeSubject(button) {
    const row = button.closest('.subject-row');
    row.remove();
    
    // Kalan derslerin indekslerini güncelle
    const container = document.getElementById('subjectsContainer');
    const rows = container.getElementsByClassName('subject-row');
    Array.from(rows).forEach((row, index) => {
        const inputs = row.getElementsByTagName('input');
        inputs[0].name = `subjects[${index}][subject]`;
        inputs[1].name = `subjects[${index}][notes]`;
    });

    // Konu seçimini sıfırla
    const topicSelect = document.getElementById('topicSelect');
    topicSelect.innerHTML = '<option value="">Konu Seçin</option>';
    $('#topicSelect').select2('destroy').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    });

    // Otomatik kaydet
    autoSave();
}

async function autoSave() {
    const container = document.getElementById('subjectsContainer');
    const rows = container.getElementsByClassName('subject-row');
    const subjects = [];

    Array.from(rows).forEach(row => {
        const inputs = row.getElementsByTagName('input');
        const subject = inputs[0].value.trim();
        const notes = inputs[1].value.trim();
        
        if (subject) {
            subjects.push({ subject, notes });
        }
    });

    try {
        const response = await fetch(`/students/<%= student.id %>/schedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ subjects })
        });
        
        if (!response.ok) {
            console.error('Program kaydedilirken bir hata oluştu');
        }
    } catch (error) {
        console.error('Hata:', error);
    }
}

// Select2'yi başlat
$(document).ready(function() {
    // Select2 için ortak ayarlar
    const select2Config = {
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    };

    // Select2'yi başlat ve focus event'ini ekle
    function initSelect2($select) {
        $select.select2(select2Config)
            .on('select2:open', function() {
                // Dropdown açıldığında arama kutusuna focus ol
                setTimeout(function() {
                    const searchField = document.querySelector('.select2-search__field');
                    if (searchField) {
                        searchField.focus();
                        searchField.click();
                    }
                }, 100);
            });
    }

    // İlk select'leri başlat
    $('.subject-select, .topic-select').each(function() {
        initSelect2($(this));
    });

    // Ders seçildiğinde konuları güncelle
    $('#subjectSelect').on('select2:select', function(e) {
        const topicSelect = $('#topicSelect');
        const selectedSubject = e.target.value;
        
        // Önce mevcut Select2 instance'ını yok et
        topicSelect.select2('destroy');
        
        // Konuları güncelle
        topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2(topicSelect);
    });

    // Ders seçimi değiştiğinde konuları güncelle
    $('#subjectSelect').on('change', function() {
        const topicSelect = $('#topicSelect');
        const selectedSubject = $(this).val();
        
        // Önce mevcut Select2 instance'ını yok et
        topicSelect.select2('destroy');
        
        // Konuları güncelle
        topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2(topicSelect);
    });
});

// Yeni ders satırı eklerken Select2'yi başlat
function addSubject() {
    const subjectRows = document.querySelectorAll('.subject-row');
    const newIndex = subjectRows.length;
    
    const newRow = document.createElement('div');
    newRow.className = 'subject-row row mb-3';
    newRow.innerHTML = `
        <div class="col-md-5">
            <select class="form-select subject-select" name="subjects[${newIndex}][subject]" onchange="updateTopics(this)">
                <option value="">Ders Seçin</option>
                <option value="Matematik">Matematik</option>
                <option value="Fizik">Fizik</option>
                <option value="Kimya">Kimya</option>
                <option value="Biyoloji">Biyoloji</option>
                <option value="Türkçe">Türkçe</option>
                <option value="Geometri">Geometri</option>
                <option value="Tarih">Tarih</option>
                <option value="Coğrafya">Coğrafya</option>
            </select>
        </div>
        <div class="col-md-5">
            <select class="form-select topic-select" name="subjects[${newIndex}][topic]">
                <option value="">Konu Seçin</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger" onclick="removeSubject(this)">Sil</button>
        </div>
    `;
    
    document.getElementById('subjectsContainer').appendChild(newRow);
    
    // Yeni eklenen select'ler için Select2'yi başlat
    const $newRow = $(newRow);
    $newRow.find('.subject-select, .topic-select').each(function() {
        initSelect2($(this));
    });

    // Yeni eklenen ders seçimi için event listener ekle
    $newRow.find('.subject-select').on('select2:select', function(e) {
        const $topicSelect = $newRow.find('.topic-select');
        const selectedSubject = e.target.value;
        
        // Önce mevcut Select2 instance'ını yok et
        $topicSelect.select2('destroy');
        
        // Konuları güncelle
        $topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                $topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2($topicSelect);
    });
}

// Konuları güncellerken Select2'yi güncelle
function updateTopics(select) {
    const $row = $(select).closest('.subject-row');
    const $topicSelect = $row.find('.topic-select');
    const subject = select.value;
    
    // Önce mevcut Select2 instance'ını yok et
    $topicSelect.select2('destroy');
    
    // Konuları güncelle
    $topicSelect.empty().append('<option value="">Konu Seçin</option>');
    
    if (subject && subjectTopics[subject]) {
        subjectTopics[subject].forEach(topic => {
            $topicSelect.append(new Option(topic, topic));
        });
    }
    
    // Select2'yi yeniden başlat
    initSelect2($topicSelect);
}

// Ders satırını silerken Select2'yi temizle
function removeSubject(button) {
    const row = button.closest('.subject-row');
    $(row).find('.subject-select, .topic-select').select2('destroy');
    row.remove();
    updateIndices();
}

// İndeksleri güncellerken Select2'yi güncelle
function updateIndices() {
    const rows = document.querySelectorAll('.subject-row');
    rows.forEach((row, index) => {
        const subjectSelect = row.querySelector('.subject-select');
        const topicSelect = row.querySelector('.topic-select');
        
        subjectSelect.name = `subjects[${index}][subject]`;
        topicSelect.name = `subjects[${index}][topic]`;
    });
}
</script> 