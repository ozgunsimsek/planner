<%- contentFor('body') %>


<head>
    <title>Öğrenci Detay - <%= student.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        /* Select2 özelleştirmeleri */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection--single {
            padding: 0.375rem 0.75rem;
        }

        /* Grup ayırımı - input alanlarına background */
        .subject-row.group-white input {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
        }

        .subject-row.group-gray input {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
        }

        .subject-row.group-white input:focus {
            background-color: #ffffff;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .subject-row.group-gray input:focus {
            background-color: #e3f2fd;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .subject-number {
            min-width: 35px;
            display: flex;
            justify-content: center;
        }

        /* Grup ayırımı - badge'ler için background */
        .subject-row.group-white .badge {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #e9ecef;
        }

        .subject-row.group-gray .badge {
            background-color: #e3f2fd !important;
            color: #000000 !important;
            border: 1px solid #bbdefb;
        }
    </style>
</head>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h2 class="mb-0">
            <i class="bi bi-calendar-week me-2"></i>
            Haftalık Plan
        </h2>
    </div>
    <div>
        <a href="/students/print-template/<%= student.id %>" target="_blank" class="btn btn-primary">
            Plan Görüntüle
        </a>
    </div>
</div>


<!-- Rutin Girişi -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">
            <i class="bi bi-arrow-repeat me-2"></i>
            Haftalık Rutin
        </h4>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-10">
                <label class="form-label">Rutin</label>
                <input type="text" class="form-control" id="weeklyRoutine" placeholder="Rutin giriniz..." value="<%= student.weeklyRoutine || '' %>">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-success w-100" onclick="saveRoutine()">
                    <i class="bi bi-check-lg me-2"></i>
                    Rutin Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ders Ekleme Formu -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>
            Ders Ekle
        </h4>
    </div>
    <div class="card-body">
        <form id="addSubjectForm" class="row g-3">
            <div class="col-md-5">
                <label class="form-label">Ders</label>
                <select class="form-select subject-select" id="subjectSelect" required>
                    <option value="">Ders Seçin</option>
                    <% if (global.testData.subjects && global.testData.subjects.length > 0) { %>
                        <% global.testData.subjects.forEach(function(subject) { %>
                            <option value="<%= subject.title %>"><%= subject.title %></option>
                        <% }); %>
                    <% } %>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Konu</label>
                <select class="form-select topic-select" id="topicSelect" required>
                    <option value="">Konu Seçin</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus-lg me-2"></i>
                    Ekle
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Haftalık Plan -->
<div class="card">
    <div class="card-header">
        <h4 class="mb-0">
            <i class="bi bi-book me-2"></i>
            Dersler
        </h4>
    </div>
    <div class="card-body">
        <div id="subjectsContainer" class="mb-4">
            <% if (student.weeklySchedule && student.weeklySchedule[0] && student.weeklySchedule[0].subjects) { %>
                <% student.weeklySchedule[0].subjects.forEach((subject, subjectIndex) => { %>
                    <div class="subject-row d-flex align-items-center gap-3 mb-3">
                        <div class="subject-number">
                            <span class="badge bg-primary"><%= subjectIndex + 1 %></span>
                        </div>
                        <div class="flex-grow-1">
                            <input type="text" 
                                   name="subjects[<%= subjectIndex %>][subject]" 
                                   value="<%= subject.subject %>"
                                   class="form-control"
                                   placeholder="Ders adı"
                                   onchange="autoSave()">
                        </div>
                        <div class="flex-grow-1">
                            <input type="text" 
                                   name="subjects[<%= subjectIndex %>][notes]" 
                                   value="<%= subject.notes %>"
                                   class="form-control"
                                   placeholder="Notlar"
                                   onchange="autoSave()">
                        </div>
                        <input type="hidden" 
                               name="subjects[<%= subjectIndex %>][groupId]" 
                               value="<%= subject.groupId || '' %>">
                        <button type="button" 
                                onclick="duplicateSubject(this)"
                                class="btn btn-outline-primary me-2">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                        <button type="button" 
                                onclick="removeSubject(this)"
                                class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// Rutin kaydetme fonksiyonu
async function saveRoutine() {
    const routine = document.getElementById('weeklyRoutine').value.trim();
    
    try {
        const response = await fetch(`/students/<%= student.id %>/routine`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ routine: routine })
        });
        
        if (response.ok) {
            // Başarı mesajı göster
            const button = document.querySelector('button[onclick="saveRoutine()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-lg me-2"></i>Kaydedildi!';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
            }, 2000);
        } else {
            console.error('Rutin kaydedilirken hata oluştu');
        }
    } catch (error) {
        console.error('Hata:', error);
    }
}

// Ders-Konu eşleştirmeleri - JSON'dan gelen verilerle oluştur
const subjectsData = <%- JSON.stringify(global.testData.subjects || []) %>;
const subjectTopics = {};
if (subjectsData && subjectsData.length > 0) {
    subjectsData.forEach(subject => {
        subjectTopics[subject.title] = subject.values;
    });
}

// Ders listesi - JSON'dan gelen verilerle oluştur
const subjectsList = subjectsData && subjectsData.length > 0 ? subjectsData.map(subject => subject.title) : [];

// Ders numaralarını güncelle (groupId bazında gruplama)
function updateSubjectNumbers() {
    const container = document.getElementById('subjectsContainer');
    const rows = container.getElementsByClassName('subject-row');
    
    // groupId bazında numaralandırma için gruplama
    const subjectGroups = {};
    Array.from(rows).forEach((row, index) => {
        const inputs = row.getElementsByTagName('input');
        const groupId = inputs[2].value; // groupId hidden input
        
        if (!subjectGroups[groupId]) {
            subjectGroups[groupId] = [];
        }
        subjectGroups[groupId].push({ row, index });
    });
    
    // Her groupId grubu için numaralandırma ve renklendirme yap
    const groupKeys = Object.keys(subjectGroups);
    groupKeys.forEach((groupId, groupIndex) => {
        const isWhiteGroup = groupIndex % 2 === 0; // Çift indeksler beyaz, tek indeksler gri
        
        subjectGroups[groupId].forEach((item, itemIndex) => {
            const badge = item.row.querySelector('.subject-number .badge');
            if (badge) {
                badge.textContent = itemIndex + 1;
            }
            
            // Grup rengini ayarla
            item.row.className = item.row.className.replace(/group-\w+/g, ''); // Eski grup sınıflarını temizle
            item.row.classList.add(isWhiteGroup ? 'group-white' : 'group-gray');
        });
    });
}

// Tüm ders verilerini güncelle (input isimleri + numaralar)
function updateAllSubjectData() {
    const container = document.getElementById('subjectsContainer');
    const rows = container.getElementsByClassName('subject-row');
    
    // Input isimlerini güncelle
    Array.from(rows).forEach((row, index) => {
        const inputs = row.getElementsByTagName('input');
        inputs[0].name = `subjects[${index}][subject]`;
        inputs[1].name = `subjects[${index}][notes]`;
    });
    
    // Numaraları güncelle
    updateSubjectNumbers();
}

// Ders seçildiğinde konuları güncelle
document.getElementById('subjectSelect').addEventListener('change', function() {
    const topicSelect = document.getElementById('topicSelect');
    const selectedSubject = this.value;
    
    // Konu seçimini sıfırla
    topicSelect.innerHTML = '<option value="">Konu Seçin</option>';
    
    if (selectedSubject && subjectTopics[selectedSubject]) {
        subjectTopics[selectedSubject].forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
        });
    }
});

// Yeni ders ekleme
document.getElementById('addSubjectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subject = document.getElementById('subjectSelect').value;
    const topic = document.getElementById('topicSelect').value;
    
    if (!subject || !topic) return;
    
    const container = document.getElementById('subjectsContainer');
    const subjectCount = container.children.length;
    
    // Aynı ders için mevcut groupId'yi bul veya yeni oluştur
    let groupId = '';
    const existingRows = container.getElementsByClassName('subject-row');
    for (let i = 0; i < existingRows.length; i++) {
        const existingInputs = existingRows[i].getElementsByTagName('input');
        const existingSubject = existingInputs[0].value.trim();
        if (existingSubject === subject) {
            groupId = existingInputs[2].value; // groupId hidden input
            break;
        }
    }
    
    // Eğer aynı ders bulunamadıysa yeni groupId oluştur
    if (!groupId) {
        groupId = 'group_' + subject.replace(/\s+/g, '_') + '_' + Date.now();
    }
    
    const subjectRow = document.createElement('div');
    subjectRow.className = 'subject-row d-flex align-items-center gap-3 mb-3 group-white';
    subjectRow.innerHTML = `
        <div class="subject-number">
            <span class="badge bg-primary">${subjectCount + 1}</span>
        </div>
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[${subjectCount}][subject]" 
                   value="${subject}"
                   class="form-control"
                   placeholder="Ders adı"
                   onchange="autoSave()">
        </div>
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[${subjectCount}][notes]" 
                   value="${topic}"
                   class="form-control"
                   placeholder="Notlar"
                   onchange="autoSave()">
        </div>
        <input type="hidden" 
               name="subjects[${subjectCount}][groupId]" 
               value="${groupId}">
        <button type="button" 
                onclick="duplicateSubject(this)"
                class="btn btn-outline-primary me-2">
            <i class="bi bi-plus-circle"></i>
        </button>
        <button type="button" 
                onclick="removeSubject(this)"
                class="btn btn-outline-danger">
            <i class="bi bi-trash"></i>
        </button>
    `;
    
    // Aynı dersin grubunun sonuna ekle
    const allRows = Array.from(container.getElementsByClassName('subject-row'));
    let insertIndex = allRows.length; // Varsayılan olarak en sona
    
    for (let i = 0; i < allRows.length; i++) {
        const currentRow = allRows[i];
        const currentInputs = currentRow.getElementsByTagName('input');
        const currentGroupId = currentInputs[2].value; // groupId hidden input
        
        // Aynı grup bulunduğunda, bir sonraki farklı grubun başlangıcını bul
        if (currentGroupId === groupId) {
            // Bu grubun son elemanını bul
            for (let j = i + 1; j < allRows.length; j++) {
                const nextRow = allRows[j];
                const nextInputs = nextRow.getElementsByTagName('input');
                const nextGroupId = nextInputs[2].value;
                
                if (nextGroupId !== groupId) {
                    insertIndex = j;
                    break;
                }
            }
            break;
        }
    }
    
    // Doğru konuma ekle
    if (insertIndex >= allRows.length) {
        container.appendChild(subjectRow);
    } else {
        container.insertBefore(subjectRow, allRows[insertIndex]);
    }
    
    // Tüm numaraları yeniden düzenle
    updateSubjectNumbers();
    
    // Formu sıfırla
    this.reset();
    
    // Select2'leri sıfırla
    $('#subjectSelect').val('').trigger('change');
    $('#topicSelect').val('').trigger('change');
    
    // Konu seçimini sıfırla
    document.getElementById('topicSelect').innerHTML = '<option value="">Konu Seçin</option>';
    $('#topicSelect').select2('destroy').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    });

    // Otomatik kaydet
    await autoSave();
});

// Ders çoğaltma
async function duplicateSubject(button) {
    const row = button.closest('.subject-row');
    const inputs = row.getElementsByTagName('input');
    const subject = inputs[0].value.trim();
    const notes = inputs[1].value.trim();
    const groupId = inputs[2].value; // groupId hidden input
    
    if (!subject) return; // Ders adı yoksa çoğaltma
    
    const container = document.getElementById('subjectsContainer');
    const allRows = Array.from(container.getElementsByClassName('subject-row'));
    
    // Aynı groupId'nin en son elemanını bul
    let insertIndex = allRows.length; // Varsayılan olarak en sona
    
    for (let i = 0; i < allRows.length; i++) {
        const currentRow = allRows[i];
        const currentInputs = currentRow.getElementsByTagName('input');
        const currentGroupId = currentInputs[2].value; // groupId hidden input
        
        // Aynı grup bulunduğunda, bir sonraki farklı grubun başlangıcını bul
        if (currentGroupId === groupId) {
            // Bu grubun son elemanını bul
            for (let j = i + 1; j < allRows.length; j++) {
                const nextRow = allRows[j];
                const nextInputs = nextRow.getElementsByTagName('input');
                const nextGroupId = nextInputs[2].value;
                
                if (nextGroupId !== groupId) {
                    insertIndex = j;
                    break;
                }
            }
            break;
        }
    }
    
    // Yeni satır oluştur (aynı groupId ile)
    const newSubjectRow = document.createElement('div');
    newSubjectRow.className = 'subject-row d-flex align-items-center gap-3 mb-3 group-white';
    newSubjectRow.innerHTML = `
        <div class="subject-number">
            <span class="badge bg-primary">1</span>
        </div>
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[0][subject]" 
                   value="${subject}"
                   class="form-control"
                   placeholder="Ders adı"
                   onchange="autoSave()">
        </div>
        <div class="flex-grow-1">
            <input type="text" 
                   name="subjects[0][notes]" 
                   value="${notes}"
                   class="form-control"
                   placeholder="Notlar"
                   onchange="autoSave()">
        </div>
        <input type="hidden" 
               name="subjects[0][groupId]" 
               value="${groupId}">
        <button type="button" 
                onclick="duplicateSubject(this)"
                class="btn btn-outline-primary me-2">
            <i class="bi bi-plus-circle"></i>
        </button>
        <button type="button" 
                onclick="removeSubject(this)"
                class="btn btn-outline-danger">
            <i class="bi bi-trash"></i>
        </button>
    `;
    
    // Doğru konuma ekle
    if (insertIndex >= allRows.length) {
        container.appendChild(newSubjectRow);
    } else {
        container.insertBefore(newSubjectRow, allRows[insertIndex]);
    }
    
    // Tüm input isimlerini ve numaraları yeniden düzenle
    updateAllSubjectData();
    
    // Otomatik kaydet
    await autoSave();
}

// Ders silme
async function removeSubject(button) {
    const row = button.closest('.subject-row');
    row.remove();
    
    // Tüm ders verilerini güncelle
    updateAllSubjectData();

    // Konu seçimini sıfırla
    const topicSelect = document.getElementById('topicSelect');
    topicSelect.innerHTML = '<option value="">Konu Seçin</option>';
    $('#topicSelect').select2('destroy').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    });

    // Otomatik kaydet
    await autoSave();
}

async function autoSave() {
    const container = document.getElementById('subjectsContainer');
    const rows = container.getElementsByClassName('subject-row');
    const subjects = [];

    Array.from(rows).forEach(row => {
        const inputs = row.getElementsByTagName('input');
        const subject = inputs[0].value.trim();
        const notes = inputs[1].value.trim();
        const groupId = inputs[2].value; // groupId hidden input
        
        if (subject) {
            subjects.push({ subject, notes, groupId });
        }
    });

    // Ders adı değişikliklerinde numaraları güncelle
    updateSubjectNumbers();

    try {
        const response = await fetch(`/students/<%= student.id %>/schedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ subjects })
        });
        
        if (!response.ok) {
            console.error('Program kaydedilirken bir hata oluştu');
        }
    } catch (error) {
        console.error('Hata:', error);
    }
}

// Select2'yi başlat
$(document).ready(function() {
    // Select2 için ortak ayarlar
    const select2Config = {
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seçiniz...',
        allowClear: true,
        dropdownAutoWidth: true,
        openOnEnter: false
    };

    // Select2'yi başlat ve focus event'ini ekle
    function initSelect2($select) {
        $select.select2(select2Config)
            .on('select2:open', function() {
                // Dropdown açıldığında arama kutusuna focus ol
                setTimeout(function() {
                    const searchField = document.querySelector('.select2-search__field');
                    if (searchField) {
                        searchField.focus();
                        searchField.click();
                    }
                }, 100);
            });
    }

    // İlk select'leri başlat
    $('.subject-select, .topic-select').each(function() {
        initSelect2($(this));
    });

    // Sayfa yüklendiğinde grup renklerini uygula
    updateSubjectNumbers();

    // Ders seçildiğinde konuları güncelle
    $('#subjectSelect').on('select2:select', function(e) {
        const topicSelect = $('#topicSelect');
        const selectedSubject = e.target.value;
        
        // Önce mevcut Select2 instance'ını yok et
        topicSelect.select2('destroy');
        
        // Konuları güncelle
        topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2(topicSelect);
    });

    // Ders seçimi değiştiğinde konuları güncelle
    $('#subjectSelect').on('change', function() {
        const topicSelect = $('#topicSelect');
        const selectedSubject = $(this).val();
        
        // Önce mevcut Select2 instance'ını yok et
        topicSelect.select2('destroy');
        
        // Konuları güncelle
        topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2(topicSelect);
    });
});

// Yeni ders satırı eklerken Select2'yi başlat
function addSubject() {
    const subjectRows = document.querySelectorAll('.subject-row');
    const newIndex = subjectRows.length;
    
    const newRow = document.createElement('div');
    newRow.className = 'subject-row row mb-3';
    newRow.innerHTML = `
        <div class="col-md-5">
            <select class="form-select subject-select" name="subjects[${newIndex}][subject]" onchange="updateTopics(this)">
                <option value="">Ders Seçin</option>
                ${subjectsList.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
            </select>
        </div>
        <div class="col-md-5">
            <select class="form-select topic-select" name="subjects[${newIndex}][topic]">
                <option value="">Konu Seçin</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger" onclick="removeSubject(this)">Sil</button>
        </div>
    `;
    
    document.getElementById('subjectsContainer').appendChild(newRow);
    
    // Yeni eklenen select'ler için Select2'yi başlat
    const $newRow = $(newRow);
    $newRow.find('.subject-select, .topic-select').each(function() {
        initSelect2($(this));
    });

    // Yeni eklenen ders seçimi için event listener ekle
    $newRow.find('.subject-select').on('select2:select', function(e) {
        const $topicSelect = $newRow.find('.topic-select');
        const selectedSubject = e.target.value;
        
        // Önce mevcut Select2 instance'ını yok et
        $topicSelect.select2('destroy');
        
        // Konuları güncelle
        $topicSelect.empty().append('<option value="">Konu Seçin</option>');
        
        if (selectedSubject && subjectTopics[selectedSubject]) {
            subjectTopics[selectedSubject].forEach(topic => {
                $topicSelect.append(new Option(topic, topic));
            });
        }
        
        // Select2'yi yeniden başlat
        initSelect2($topicSelect);
    });
}

// Konuları güncellerken Select2'yi güncelle
function updateTopics(select) {
    const $row = $(select).closest('.subject-row');
    const $topicSelect = $row.find('.topic-select');
    const subject = select.value;
    
    // Önce mevcut Select2 instance'ını yok et
    $topicSelect.select2('destroy');
    
    // Konuları güncelle
    $topicSelect.empty().append('<option value="">Konu Seçin</option>');
    
    if (subject && subjectTopics[subject]) {
        subjectTopics[subject].forEach(topic => {
            $topicSelect.append(new Option(topic, topic));
        });
    }
    
    // Select2'yi yeniden başlat
    initSelect2($topicSelect);
}


</script> 